# GAD-7 Parent Build Script

FROM openanalytics/r-base

MAINTAINER Psychlytx "psychlytx@gmail.com"

# system libraries of general use
RUN apt-get update && apt-get install -y \
    sudo \
    pandoc \
    pandoc-citeproc \
    libcurl4-gnutls-dev \
    libcairo2-dev \
    libxt-dev \
    libssl-dev \
    libssh2-1-dev \
    libxml2-dev \
    libssl1.0.0 \
    libpq-dev \
    git \
    html-xml-utils \
    libv8-3.14-dev

# update system library dependency for the app

RUN apt-get update

# install tinytex.

RUN wget -qO- "https://yihui.name/gh/tinytex/tools/install-unx.sh" \
  | sh -s - --admin --no-path
RUN sudo ~/.TinyTeX/bin/*/tlmgr path add
RUN chown -R root:staff ~/.TinyTeX
RUN chmod -R g+w ~/.TinyTeX
RUN chmod -R g+wx ~/.TinyTeX/bin

# install required system libraries such as Postgresql.

RUN apt-get install postgresql -y
RUN apt-get install libpq-dev -y

# install packages for R
# install CRAN packages for R
RUN R -e "install.packages(c('hms','devtools'), repos='https://cloud.r-project.org/')"
RUN R -e "require(devtools)"

RUN R -e "install.packages('tibble', dependencies=TRUE)"
RUN R -e "install.packages('shinyBS', dependencies=TRUE)"
RUN R -e "install.packages('uuid', dependencies=TRUE)"
RUN R -e "install.packages('httr', dependencies=TRUE)"
RUN R -e "install.packages('purrrlyr', dependencies=TRUE)"
RUN R -e "install.packages('shinycssloaders', dependencies=TRUE)"
RUN R -e "install.packages('shinyWidgets', dependencies=TRUE)"
RUN R -e "install.packages('shinyhelper', dependencies=TRUE)"
RUN R -e "install.packages('extrafont', dependencies=TRUE)"
RUN R -e "install.packages('extrafontdb', dependencies=TRUE)"
RUN R -e "install.packages('memor', dependencies=TRUE)"
RUN R -e "install.packages('ggplot2', dependencies=TRUE)"
RUN R -e "install.packages('pool', dependencies=TRUE)"
RUN R -e "install.packages('DBI', dependencies=TRUE)"
RUN R -e "install.packages('RPostgreSQL', dependencies=TRUE)"
RUN R -e "install.packages('lubridate', dependencies=TRUE)"
RUN R -e "install.packages('chron', dependencies=TRUE)"
RUN R -e "install.packages('purrr', dependencies=TRUE)"
RUN R -e "install.packages('tidyr', dependencies=TRUE)"
RUN R -e "install.packages('DT', dependencies=TRUE)"
RUN R -e "install.packages('shinydashboard', dependencies=TRUE)"
RUN R -e "install.packages('magrittr', dependencies=TRUE)"
RUN R -e "install.packages('ggrepel', dependencies=TRUE)"
RUN R -e "install.packages('dplyr', dependencies=TRUE)"
RUN R -e "install.packages('shinyjs', dependencies=TRUE)"
RUN R -e "install.packages('shiny', dependencies=TRUE)"
RUN R -e "install.packages('knitr', dependencies=TRUE)"
RUN R -e "install.packages('car', dependencies=TRUE)"
RUN R -e "install.packages('kableExtra', dependencies=TRUE)"

# TinyTex installation and configuration.
RUN R -e "install.packages('tinytex', dependencies=TRUE)"
RUN R -e "tinytex::install_tinytex()"
RUN R -e "tinytex::tlmgr_install('xltxtra')"
RUN R -e "tinytex::tlmgr_install('realscripts')"
RUN R -e "tinytex::tlmgr_install('ms')"
RUN R -e "tinytex::tlmgr_install('setspace')"
RUN R -e "tinytex::tlmgr_install('lastpage')"
RUN R -e "tinytex::tlmgr_install('libertine')"
RUN R -e "tinytex::tlmgr_install('units')"
RUN R -e "tinytex::tlmgr_install('was')"
RUN R -e "tinytex::tlmgr_install('multirow')"
RUN R -e "tinytex::tlmgr_install('xcolor')"
RUN R -e "tinytex::tlmgr_install('wrapfig')"
RUN R -e "tinytex::tlmgr_install('colortbl')"
RUN R -e "tinytex::tlmgr_install('tabu')"
RUN R -e "tinytex::tlmgr_install('varwidth')"
RUN R -e "tinytex::tlmgr_install('threeparttable')"
RUN R -e "tinytex::tlmgr_install('fontfamily')"
RUN R -e "tinytex::tlmgr_install('lmodern')"
RUN R -e "tinytex::tlmgr_install('amssymb')"
RUN R -e "tinytex::tlmgr_install('amsmath')"
RUN R -e "tinytex::tlmgr_install('ifxetex')"
RUN R -e "tinytex::tlmgr_install('ifluatex')"
RUN R -e "tinytex::tlmgr_install('fixltx2e')"
RUN R -e "tinytex::tlmgr_install('fontenc')"
RUN R -e "tinytex::tlmgr_install('inputenc')"
RUN R -e "tinytex::tlmgr_install('eurosym')"
RUN R -e "tinytex::tlmgr_install('mathspec')"
RUN R -e "tinytex::tlmgr_install('xunicode')"
RUN R -e "tinytex::tlmgr_install('fontspec')"
RUN R -e "tinytex::tlmgr_install('upquote')"
RUN R -e "tinytex::tlmgr_install('microtype')"
RUN R -e "tinytex::tlmgr_install('geometry')"
RUN R -e "tinytex::tlmgr_install('hyperref')"
RUN R -e "tinytex::tlmgr_install('polyglossia')"
RUN R -e "tinytex::tlmgr_install('babel')"
RUN R -e "tinytex::tlmgr_install('natbib')"
RUN R -e "tinytex::tlmgr_install('biblatex')"
RUN R -e "tinytex::tlmgr_install('listings')"
RUN R -e "tinytex::tlmgr_install('fancyvrb')"
RUN R -e "tinytex::tlmgr_install('longtable')"
RUN R -e "tinytex::tlmgr_install('booktabs')"
RUN R -e "tinytex::tlmgr_install('graphics')"
RUN R -e "tinytex::tlmgr_install('ulem')"
RUN R -e "tinytex::tlmgr_install('titling')"
RUN R -e "tinytex::tlmgr_install('ragged2e')"
RUN R -e "tinytex::tlmgr_install('ctex')"
RUN R -e "tinytex::tlmgr_install('gensymb')"
RUN R -e "tinytex::tlmgr_install('array')"
RUN R -e "tinytex::tlmgr_install('float')"
RUN R -e "tinytex::tlmgr_install('pdflscape')"
RUN R -e "tinytex::tlmgr_install('threeparttablex')"
RUN R -e "tinytex::tlmgr_install('makecell')"
RUN R -e "tinytex::tlmgr_install('footmisc')"
RUN R -e "tinytex::tlmgr_install('chngcntr')"
RUN R -e "tinytex::tlmgr_install('caption')"
RUN R -e "tinytex::tlmgr_install('fancyhdr')"
RUN R -e "tinytex::tlmgr_install('titlesec')"
RUN R -e "tinytex::tlmgr_install('enumitem')"
RUN R -e "tinytex::tlmgr_install('tikz')"
RUN R -e "tinytex::tlmgr_install('xwatermark')"
RUN R -e "tinytex::tlmgr_install('environ')"
RUN R -e "tinytex::tlmgr_install('trimspaces')"

# Custom package installation for R.
RUN R -e "devtools::install_version('rmarkdown', version = '1.8', repos='https://cloud.r-project.org/')"
RUN wget https://cran.r-project.org/src/contrib/base64enc_0.1-3.tar.gz
RUN R CMD INSTALL base64enc_0.1-3.tar.gz

# install local package 'Psychlytx'
ADD ./psychlytx /psychlytx
RUN R CMD build psychlytx
RUN R CMD INSTALL psychlytx_0.0.0.9000.tar.gz

# copy the app to the image
RUN mkdir /root/gad_7_parent
COPY gad_7_parent /root/gad_7_parent

COPY Rprofile.site /usr/lib/R/etc/

# Expose port access to PostgreSQL 5432, for ShinyProxy 3838, 80 : 8080 for HTML and 443 for SSL.
EXPOSE 3838
EXPOSE 5432
EXPOSE 80
EXPOSE 8080
EXPOSE 443

CMD ["R", "-e", "shiny::runApp('/root/gad_7_parent')"]
